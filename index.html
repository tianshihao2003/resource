<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>èµ„æºåº“ Â· tianshihao2003/resource</title>

  <!-- Tailwind CDN (ç”¨äºå¿«é€Ÿæ ·å¼) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ç®€å•çš„æ¨¡æ€å’Œæ»šåŠ¨æ ·å¼å¾®è°ƒ */
    .modal-backdrop { background: rgba(0,0,0,0.55); }
    .truncate-2 { display: -webkit-box; -webkit-line-clamp:2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-900">

  <div class="max-w-6xl mx-auto p-6">
    <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-semibold">æˆ‘çš„èµ„æºåº“</h1>
        <p class="text-sm text-gray-600">ä»“åº“ï¼š<span class="font-mono">tianshihao2003 / resource</span> â€” åƒç½‘ç›˜ä¸€æ ·æµè§ˆä¸é¢„è§ˆ</p>
      </div>
      <div class="flex gap-2 items-center w-full sm:w-auto">
        <input id="search" class="border rounded px-3 py-2 text-sm w-full sm:w-72" placeholder="æœç´¢æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹ï¼ˆæŒ‰åå­—ï¼‰" />
        <button id="refreshBtn" class="ml-2 bg-blue-600 text-white px-4 py-2 rounded text-sm">åˆ·æ–°</button>
      </div>
    </header>

    <nav id="breadcrumbs" class="text-sm text-gray-600 mb-4"></nav>

    <main>
      <div id="error" class="text-red-600 mb-3"></div>

      <section id="listing" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
        <!-- åˆ—è¡¨é¡¹æ³¨å…¥è¿™é‡Œ -->
      </section>

      <div id="empty" class="text-center text-gray-500 py-10 hidden">æ­¤ç›®å½•ä¸ºç©ºæˆ–æ²¡æœ‰åŒ¹é…çš„æ–‡ä»¶ã€‚</div>
    </main>

    <footer class="mt-6 text-sm text-gray-500">
      æç¤ºï¼šå½“å‰é¡µé¢é€šè¿‡ GitHub å…¬å…± API è¯»å–æ•°æ®ã€‚è‹¥ä»“åº“ä¸ºç§æœ‰æˆ–è®¿é—®é‡å¤§ï¼Œå»ºè®®ç”¨ Cloudflare Worker æˆ–åç«¯ä»£ç†æ¥å®‰å…¨è½¬å‘çŸ­æœŸä»¤ç‰Œï¼Œé¿å…åœ¨å‰ç«¯æš´éœ²é•¿æœŸå‡­è¯å¹¶é˜²æ­¢ API é™åˆ¶ã€‚
    </footer>
  </div>

  <!-- é¢„è§ˆæ¨¡æ€ -->
  <div id="previewModal" class="fixed inset-0 flex items-center justify-center hidden">
    <div class="absolute inset-0 modal-backdrop"></div>
    <div class="relative z-10 max-w-4xl w-full bg-white rounded shadow p-4 max-h-[85vh] overflow-auto">
      <div class="flex justify-between items-center mb-3">
        <div class="font-medium" id="previewTitle">é¢„è§ˆ</div>
        <div class="flex gap-2">
          <a id="previewOpenNew" class="text-sm underline hidden" target="_blank" rel="noreferrer">åœ¨æ–°çª—å£æ‰“å¼€</a>
          <button id="previewClose" class="text-sm px-3 py-1 border rounded">å…³é—­</button>
        </div>
      </div>
      <div id="previewContent"></div>
    </div>
  </div>

<script>
/*
  Single-file Repo Drive
  - OWNER / REPO å·²è®¾å®šä¸ºä½ çš„ï¼štianshihao2003 / resource
  - ä»…é€‚ç”¨äºå…¬å¼€ä»“åº“ï¼ˆæ— éœ€ tokenï¼‰ã€‚è‹¥ä»“åº“ç§æœ‰ï¼Œè¯·åœ¨åç«¯/Worker åšä»£ç†å¹¶è¿”å›ç›¸åŒæ ¼å¼çš„æ•°æ®ã€‚
*/

const OWNER = 'tianshihao2003';
const REPO  = 'resource';

const apiBase = (path='') => `https://api.github.com/repos/${OWNER}/${REPO}/contents/${path}`;

const $ = (id) => document.getElementById(id);
const listingEl = $('listing');
const breadcrumbsEl = $('breadcrumbs');
const errorEl = $('error');
const emptyEl = $('empty');

let currentPath = ''; // '' è¡¨ç¤ºæ ¹ç›®å½•
let currentItems = [];

// helpers
function niceSize(bytes){
  if (bytes === 0) return '0B';
  if (!bytes && bytes !== 0) return '-';
  const u = ['B','KB','MB','GB'];
  let i=0; let n=bytes;
  while(n>=1024 && i<u.length-1){ n/=1024; i++; }
  return Math.round(n*10)/10 + u[i];
}
function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function iconFor(item){
  if (item.type === 'dir') return 'ğŸ“';
  const ext = (item.name.split('.').pop()||'').toLowerCase();
  if (['png','jpg','jpeg','gif','webp','svg'].includes(ext)) return 'ğŸ–¼ï¸';
  if (['mp4','mov','webm','mkv'].includes(ext)) return 'ğŸï¸';
  if (['mp3','wav','ogg'].includes(ext)) return 'ğŸµ';
  if (['pdf'].includes(ext)) return 'ğŸ“•';
  if (['zip','tar','gz','rar'].includes(ext)) return 'ğŸ—œï¸';
  if (['md','txt','json','js','py','html','css','java','c','cpp'].includes(ext)) return 'ğŸ“„';
  return 'ğŸ“¦';
}

// fetch list for a path
async function loadPath(path){
  errorEl.textContent = '';
  listingEl.innerHTML = '';
  emptyEl.classList.add('hidden');

  try{
    const res = await fetch(apiBase(path), { headers: { Accept: 'application/vnd.github.v3+json' } });
    if (res.status === 404) throw new Error('è·¯å¾„ä¸å­˜åœ¨æˆ–ä»“åº“ä¸å¯è®¿é—®ï¼ˆå¯èƒ½æ˜¯ç§æœ‰ä»“åº“ï¼‰ã€‚');
    if (res.status === 403) throw new Error('è®¿é—®è¢«é™åˆ¶ï¼šå¯èƒ½è§¦å‘ GitHub API é™åˆ¶ã€‚å»ºè®®ä½¿ç”¨ä»£ç†æˆ– tokenã€‚');
    if (!res.ok) throw new Error('GitHub API é”™è¯¯ï¼š' + res.status);
    const data = await res.json();
    // data: array (ç›®å½•) æˆ– object (å•æ–‡ä»¶)
    const arr = Array.isArray(data) ? data : [data];
    // sort: directories first, then files by name
    arr.sort((a,b) => {
      if (a.type === b.type) return a.name.localeCompare(b.name);
      return a.type === 'dir' ? -1 : 1;
    });
    currentItems = arr;
    renderList();
    renderBreadcrumbs();
  }catch(e){
    errorEl.textContent = e.message || 'åŠ è½½å¤±è´¥';
    currentItems = [];
    listingEl.innerHTML = '';
  }
}

// render breadcrumbs
function renderBreadcrumbs(){
  const parts = currentPath ? currentPath.split('/').filter(Boolean) : [];
  const crumbs = [{name:'root', path:''}].concat(parts.map((p,i)=>({name:p, path: parts.slice(0,i+1).join('/')})));
  breadcrumbsEl.innerHTML = crumbs.map((c,i) => {
    const sep = i < crumbs.length -1 ? ' / ' : '';
    return `<button data-path="${escapeHtml(c.path)}" class="hover:underline mr-2">${escapeHtml(c.name)}</button>${sep}`;
  }).join('');
  // attach clicks
  breadcrumbsEl.querySelectorAll('button[data-path]').forEach(btn => {
    btn.onclick = () => { currentPath = btn.dataset.path; loadPath(currentPath); };
  });
}

// render listing
function renderList(){
  listingEl.innerHTML = '';
  if (!currentItems || currentItems.length === 0){
    emptyEl.classList.remove('hidden');
    return;
  }
  emptyEl.classList.add('hidden');

  for (const item of currentItems){
    const sizeText = item.type === 'dir' ? 'æ–‡ä»¶å¤¹' : ( item.size !== undefined ? niceSize(item.size) : '-' );
    const card = document.createElement('div');
    card.className = 'p-3 border rounded flex items-start gap-3 hover:shadow-sm bg-white';
    const ic = document.createElement('div');
    ic.className = 'text-3xl';
    ic.textContent = iconFor(item);

    const right = document.createElement('div');
    right.className = 'flex-1';
    const topRow = document.createElement('div');
    topRow.className = 'flex justify-between items-start gap-3';
    const nameBtn = document.createElement('button');
    nameBtn.className = 'text-left font-medium truncate text-sm';
    nameBtn.style.padding = '0';
    nameBtn.textContent = item.name;
    nameBtn.onclick = () => openItem(item);

    const meta = document.createElement('div');
    meta.className = 'text-xs text-gray-500';
    meta.textContent = sizeText;

    topRow.appendChild(nameBtn);
    topRow.appendChild(meta);

    const pathLine = document.createElement('div');
    pathLine.className = 'text-xs text-gray-500 mt-1 truncate';
    pathLine.textContent = item.path || item.sha || '';

    const actions = document.createElement('div');
    actions.className = 'mt-2 flex gap-3';
    if (item.download_url){
      const a = document.createElement('a');
      a.href = item.download_url;
      a.target = '_blank';
      a.rel = 'noreferrer';
      a.className = 'text-xs underline';
      a.textContent = 'ä¸‹è½½';
      actions.appendChild(a);
    }
    if (item.html_url){
      const b = document.createElement('a');
      b.href = item.html_url;
      b.target = '_blank';
      b.rel = 'noreferrer';
      b.className = 'text-xs underline';
      b.textContent = 'åœ¨ GitHub æŸ¥çœ‹';
      actions.appendChild(b);
    }
    if (item.type !== 'dir' && item.download_url){
      const view = document.createElement('button');
      view.className = 'text-xs px-2 py-1 border rounded';
      view.textContent = 'é¢„è§ˆ';
      view.onclick = () => openItem(item);
      actions.appendChild(view);
    }

    right.appendChild(topRow);
    right.appendChild(pathLine);
    right.appendChild(actions);

    card.appendChild(ic);
    card.appendChild(right);
    listingEl.appendChild(card);
  }
}

// open item: navigate if dir; preview if previewable; open raw otherwise
async function openItem(item){
  if (item.type === 'dir'){
    currentPath = item.path.replace(new RegExp(`^${OWNER}/${REPO}/?`), '').replace(/^\/+|\/+$/g,'');
    await loadPath(currentPath);
    return;
  }

  // image preview
  if (item.download_url && /\.(png|jpg|jpeg|gif|webp|svg)$/i.test(item.name)){
    showPreview({ type:'image', src: item.download_url, name: item.name });
    return;
  }

  // text preview
  if (item.download_url && /\.(md|txt|json|js|jsx|ts|tsx|py|html|css|java|c|cpp)$/i.test(item.name)){
    try{
      showLoadingPreview('åŠ è½½ä¸­...');
      const r = await fetch(item.download_url);
      const text = await r.text();
      showPreview({ type:'text', content: text, name: item.name });
    }catch(e){
      showPreview({ type:'text', content: 'æ— æ³•åŠ è½½æ–‡ä»¶ï¼š' + (e.message||e), name: item.name });
    }
    return;
  }

  // otherwise open raw url
  if (item.download_url) window.open(item.download_url, '_blank');
}

// preview modal handling
const previewModal = $('previewModal');
const previewContent = $('previewContent');
const previewTitle = $('previewTitle');
const previewOpenNew = $('previewOpenNew');
$('previewClose').onclick = () => hidePreview();

function showLoadingPreview(msg='åŠ è½½ä¸­...'){
  previewTitle.textContent = 'é¢„è§ˆ';
  previewContent.innerHTML = `<div class="text-center py-10 text-gray-600">${escapeHtml(msg)}</div>`;
  previewOpenNew.classList.add('hidden');
  previewModal.classList.remove('hidden');
}
function showPreview({type, src, content, name}){
  previewTitle.textContent = name || 'é¢„è§ˆ';
  previewContent.innerHTML = '';
  previewOpenNew.classList.add('hidden');

  if (type === 'image'){
    const img = document.createElement('img');
    img.src = src;
    img.alt = name || '';
    img.className = 'max-h-[70vh] mx-auto';
    previewContent.appendChild(img);
    previewOpenNew.href = src;
    previewOpenNew.classList.remove('hidden');
  } else if (type === 'text'){
    const pre = document.createElement('pre');
    pre.className = 'whitespace-pre-wrap text-sm bg-gray-100 p-3 rounded max-h-[70vh] overflow-auto';
    pre.textContent = content || '';
    previewContent.appendChild(pre);
  } else {
    previewContent.textContent = 'ä¸æ”¯æŒçš„é¢„è§ˆç±»å‹';
  }
  previewModal.classList.remove('hidden');
}
function hidePreview(){
  previewModal.classList.add('hidden');
  previewContent.innerHTML = '';
}

// search & refresh handlers
$('refreshBtn').onclick = () => loadPath(currentPath);
$('search').addEventListener('input', (e) => {
  const q = e.target.value.trim().toLowerCase();
  if (!currentItems || currentItems.length === 0) return renderList();
  const filtered = currentItems.filter(i => i.name.toLowerCase().includes(q));
  // temporarily render filtered
  listingEl.innerHTML = '';
  if (filtered.length === 0){ emptyEl.classList.remove('hidden'); } else { emptyEl.classList.add('hidden'); }
  for (const item of filtered){
    const clone = Object.assign({}, item);
    // build card similarly (quick reuse by calling small function)
    const sizeText = clone.type === 'dir' ? 'æ–‡ä»¶å¤¹' : ( clone.size !== undefined ? niceSize(clone.size) : '-' );
    const card = document.createElement('div');
    card.className = 'p-3 border rounded flex items-start gap-3 hover:shadow-sm bg-white';
    const ic = document.createElement('div'); ic.className = 'text-3xl'; ic.textContent = iconFor(clone);
    const right = document.createElement('div'); right.className = 'flex-1';
    const topRow = document.createElement('div'); topRow.className = 'flex justify-between items-start gap-3';
    const nameBtn = document.createElement('button'); nameBtn.className = 'text-left font-medium truncate text-sm'; nameBtn.style.padding='0';
    nameBtn.textContent = clone.name; nameBtn.onclick = () => openItem(clone);
    const meta = document.createElement('div'); meta.className='text-xs text-gray-500'; meta.textContent=sizeText;
    topRow.appendChild(nameBtn); topRow.appendChild(meta);
    const pathLine = document.createElement('div'); pathLine.className='text-xs text-gray-500 mt-1 truncate'; pathLine.textContent=clone.path||'';
    const actions = document.createElement('div'); actions.className='mt-2 flex gap-3';
    if (clone.download_url){ const a = document.createElement('a'); a.href=clone.download_url; a.target='_blank'; a.rel='noreferrer'; a.className='text-xs underline'; a.textContent='ä¸‹è½½'; actions.appendChild(a); }
    if (clone.html_url){ const b = document.createElement('a'); b.href=clone.html_url; b.target='_blank'; b.rel='noreferrer'; b.className='text-xs underline'; b.textContent='åœ¨ GitHub æŸ¥çœ‹'; actions.appendChild(b); }
    if (clone.type !== 'dir' && clone.download_url){ const view = document.createElement('button'); view.className='text-xs px-2 py-1 border rounded'; view.textContent='é¢„è§ˆ'; view.onclick = () => openItem(clone); actions.appendChild(view); }
    right.appendChild(topRow); right.appendChild(pathLine); right.appendChild(actions);
    card.appendChild(ic); card.appendChild(right);
    listingEl.appendChild(card);
  }
});

// initial load
loadPath('');

// keyboard: Esc to close preview
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') hidePreview();
});
</script>
</body>
</html>
